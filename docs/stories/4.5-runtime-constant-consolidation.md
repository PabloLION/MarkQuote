# Story 4.5 - Runtime Constant Consolidation

**Status:** Done
**Priority:** First (foundation for other Epic 4 stories)

## Overview

Extract shared runtime constants (clipboard capabilities, loader timeouts,
status labels, error codes, trigger sources) into a single module to reduce
duplication and ensure consistency across background, popup, and options
surfaces. This foundational work enables cleaner implementations for the
diagnostics and feedback stories that follow.

## Objectives

- Audit codebase for scattered constants and magic strings/numbers
- Create centralized constants module with TypeScript types
- Update all consumers to use shared constants
- Ensure tree-shaking eliminates unused constants from bundles

## Deliverables

- `src/lib/constants.ts` exporting all shared runtime values
- TypeScript const objects for type-safe usage
- Updated imports across background, popup, and options modules
- Documentation in code comments explaining each constant group

## Acceptance Criteria

- [x] Single constants module exports all shared values
- [x] **Trigger sources:** `TRIGGER_SOURCE.POPUP`, `TRIGGER_SOURCE.HOTKEY`,
  `TRIGGER_SOURCE.CONTEXT_MENU`
- [x] **Message types:** `MESSAGE_TYPE` for all runtime messages
- [x] **Timeout values:** `TIMEOUTS` for loader timeouts, debounce intervals
- [x] **Limits:** `LIMITS` for error log max, badge max, clipboard max
- [x] **Status labels:** `STATUS_MESSAGES` for success/error message templates
- [x] **Storage keys:** `STORAGE_KEYS` for session/local storage keys
- [x] **Context menu IDs:** `CONTEXT_MENU_IDS` for chrome.contextMenus
- [x] **Colors:** `COLORS` for UI color constants
- [x] No duplicate magic strings/numbers remain in codebase
- [x] TypeScript provides autocomplete and type checking for all constants
- [x] Bundle size impact is negligible (tree-shaking verified)
- [x] All 282 unit tests pass
- [x] Production build succeeds

## Implementation Summary

Created `src/lib/constants.ts` with the following constant groups:

```typescript
export const TRIGGER_SOURCE = {
  POPUP: "popup",
  HOTKEY: "hotkey",
  CONTEXT_MENU: "context-menu",
  E2E: "e2e",
  UNKNOWN: "unknown",
} as const;

export const MESSAGE_TYPE = {
  COPIED_TEXT_PREVIEW: "copied-text-preview",
  COPY_PROTECTED: "copy-protected",
  POPUP_READY: "popup-ready",
  POPUP_CLOSED: "popup-closed",
  REQUEST_SELECTION_COPY: "request-selection-copy",
  GET_ERROR_LOG: "get-error-log",
  CLEAR_ERROR_LOG: "clear-error-log",
} as const;

export const TIMEOUTS = {
  POPUP_PREVIEW_RETRY_MS: 100,
  HOTKEY_POPUP_MS: 1000,
  STATUS_DISPLAY_MS: 3000,
  CLEAR_CONFIRMATION_MS: 5000,
  LOADER_MS: 5000,
} as const;

export const LIMITS = {
  ERROR_LOG_MAX_ENTRIES: 10,
  BADGE_MAX_COUNT: 99,
  POPUP_PREVIEW_MAX_RETRIES: 3,
  CLIPBOARD_MAX_BYTES: 1_000_000,
  REGEX_PATTERN_MAX_LENGTH: 500,
  REGEX_PREVIEW_LENGTH: 64,
} as const;

// ... plus COLORS, STORAGE_KEYS, STATUS_MESSAGES, URLS, CONTEXT_MENU_IDS
```

Updated consumers:

- `src/background/index.ts`
- `src/background/copy-pipeline.ts`
- `src/background/context-menus.ts`
- `src/background/errors.ts`
- `src/background/constants.ts`
- `src/background/types.ts`
- `src/surfaces/popup/state.ts`
- `src/surfaces/popup/helpers/copy-flow.ts`
- `src/surfaces/popup/helpers/runtime-bridge.ts`
- `src/surfaces/options/state.ts`
- `src/surfaces/options/page.ts`

## Risks & Mitigations

- **Import cycles:** Avoided by keeping constants leaf-level with no imports
  from other src modules
- **Bundle size:** Tree-shaking verified; constants module adds ~2KB gzip
- **Breaking changes:** All usages updated; backward-compatible re-exports in
  existing modules

## References

- Enables: Story 4.4 (Background Alignment), Story 4.3 (Diagnostics)
- Related: Story 4.2 (Feedback UX), Story 4.1 (Confirmation Toggle)
