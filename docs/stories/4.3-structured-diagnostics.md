# Story 4.3 - Structured Diagnostics & GitHub Handoff

**Status:** Done
**Depends on:** Story 4.5 (Runtime Constants), Story 4.4 (Background Alignment)

## Overview

Upgrade the error-reporting pipeline so developers and testers can reproduce
failures quickly. Today the popup surfaces terse messages, there is no copyable
payload, and background logs omit context such as the source trigger or tab URL.
Smoke testing during Story 3.9 exposed how hard it is to diagnose clipboard
regressions without richer diagnostics.

## Objectives

- Embed structured metadata (trigger source, tab URL, stack traces, clipboard
  status) into every error captured by the background worker.
- Surface a "Copy error details" action in the popup that copies JSON/markdown
  diagnostics to the clipboard.
- Ensure error badges, popups, and logs stay in sync when errors are cleared or
  reset between tests.
- Generate URL-safe export format for GitHub issue templates.
- Update documentation so contributors know how to harvest error details during
  manual validation.

## Deliverables

- Background enhancements that record and expose structured error details.
- Popup UI affordance ("Copy details" button) plus associated tests.
- Updated Playwright and unit coverage to confirm error logging across
  clear/reset cycles.
- Documentation updates (`docs/dev/test-coverage.md`,
  `docs/dev/troubleshooting.md` if needed).

## Acceptance Criteria

- [x] Every captured error includes: trigger source, tab URL (if available),
      message, stack, clipboard status flags, extension version, Chrome version
- [x] Popup error list displays a "Copy details" control that copies the full
      diagnostic payload
- [x] Copied format is markdown-friendly for GitHub issues
- [x] Clearing errors via the popup or reset commands removes stored diagnostics
      and badge counts
- [x] No PII or page content in diagnostic output (privacy-safe)
- [x] New tests validate both the data structure and the UI flow
- [x] Diagnostics storage capped to avoid bloating sync/state

## Technical Notes

- Define `DiagnosticEntry` interface in shared types
- Store diagnostics in `chrome.storage.local` (not sync - can be large)
- Cap at ~20 entries with FIFO eviction
- Export format: markdown code block with JSON for easy GitHub paste

## Risks & Mitigations

- **Clipboard security:** Ensure copied diagnostics explicitly indicate
  sensitive fields and warn users before sharing
- **Service worker size:** Compress diagnostics storage or cap entry counts
- **UX clutter:** Keep the popup affordance compact; consider a details drawer
  if space becomes tight

## References

- Supersedes: `docs/stories/backlog/error-diagnostics-overhaul.md`
- Related: Story 4.4 (Background Alignment), Story 4.5 (Constants)

## Implementation Summary

Completed in branch `feat/story-4.3-structured-diagnostics`.

### Changes Made

1. **DiagnosticMetadata type** (`src/background/types.ts`):
   - `source?: TriggerSource` - copy trigger source (popup, hotkey, context-menu)
   - `tabUrl?: string` - hostname only for privacy
   - `tabId?: number` - tab ID for correlation
   - `stack?: string` - error stack trace if available
   - `extensionVersion: string` - from manifest
   - `userAgent: string` - browser user agent

2. **recordError enhancement** (`src/background/errors.ts`):
   - Added `buildDiagnosticMetadata()` helper
   - Added `extractHostname()` for privacy-preserving URL storage
   - Diagnostics automatically captured with every error

3. **Copy details button** (`public/popup.html`, `src/surfaces/popup/errors.ts`):
   - New "Copy details" button in error actions
   - `formatErrorsAsMarkdown()` generates GitHub-friendly report
   - Includes collapsible stack traces using `<details>` tags
   - Visual feedback ("Copied!") on success

4. **Tests**:
   - 8 new tests for structured diagnostics in `background.errors.test.ts`
   - 5 new tests for copy details functionality in `popup.errors.test.ts`
   - All 297 unit tests passing
   - All 10 E2E tests passing
