# Story 3.10 – E2E Scenario Matrix Hardening

## Overview

Story 3.10 expands the Playwright suite beyond the single-copy happy paths
covered in Story 3.9. Real users frequently trigger multiple capture flows in
rapid succession (e.g., toolbar → hotkey → context menu) and expect each
interaction to land fresh content on the clipboard without stale previews or
error leakage. Our current specs do not simulate those sequences, leaving gaps
that allowed the unpinned hotkey regression to ship undetected.

## Objectives

- Model chained copy sequences that mix triggers (toolbar action, keyboard
  shortcut, context menu) without resetting the background worker.
- Validate clipboard contents between steps using nonce tagging and diagnostics
  so we can distinguish fresh copies from relic data.
- Exercise repeated use of a single trigger to ensure debouncing, pending-source
  clearing, and preview resets behave as designed.
- Capture edge-case flows such as copy failures after a successful run (e.g.,
  protected URL on second call) to verify error badges and logs stay coherent.

## Deliverables

- New Playwright specs (or expansions of existing suites) that cover:
  - Hotkey → popup → context menu chain
  - Context menu twice in a row across different tabs
  - Toolbar popup followed immediately by hotkey fallback
  - Mixed-success sequences (success followed by failure, and vice versa)
- Helper utilities that mint per-run clipboard tokens and expose assertion
  helpers.
- Updated smoke-tag annotations so at least one multi-step flow runs under
  `--grep "[smoke]"`.

## Acceptance Criteria

- `pnpm test:e2e` passes with the new sequences, and each spec asserts clipboard
  contents for every step.
- Background diagnostics confirm pending copy sources, preview cache, and error
  logs reset appropriately between steps.
- No new flakiness is introduced (target <1% failure rate across five
  consecutive runs locally).

## Risks & Mitigations

- **Clipboard race conditions**: inject small waits and rely on diagnostics
  polling instead of arbitrary timeouts.
- **Service worker lifespan**: ensure the suite reuses the same extension
  session so cross-step state is observable.
- **Runtime growth**: gate long sequences behind the smoke tag to keep default
  runs manageable.

## References

- Backlog: Follow-up tasks under “Story 3.9 Completion Tasks”
- Existing docs: `docs/dev/test-coverage.md`
