# Story 3.3: Broaden End-to-End Coverage

## Status

Completed

## Story

**As a** maintainer who relies on full-fidelity regression checks,
**I want** Playwright-based scenarios that exercise the end-to-end selection and formatting workflow,
**so that** shipping UI or rules-engine changes cannot break the user-critical copy flow without detection.

## Acceptance Criteria

1. A Playwright project runs against the dev harness and verifies the full copy pipeline: selecting text on a sample page, triggering the background copy handler, and confirming the popup preview renders the markdown template output.
2. E2E coverage proves rule application: updating title and URL rules inside the options UI is reflected in the popup preview during the same session.
3. Break/continue matching behavior is validated by chaining multiple URL rules and asserting the resulting preview (including the default UTM and Amazon examples).
4. Tests assert dark-/light-mode parity by running with both color schemes or mocking the CSS media query, ensuring no regressions in theming-sensitive UI.
5. Specs clean up after themselves (closing Chromium, resetting temporary storage) and run deterministically on CI via an updated workflow job.

## Tasks / Subtasks

- [x] Create Playwright fixtures/helpers to seed chrome.storage (title/url rules, template) and to emit selection previews without relying on real Chrome APIs. (AC: 1, 2)
- [x] Author scenarios covering default flow, rule editing flow, and break-behavior validation; reuse shared assertions for popup content. (AC: 1â€“3)
- [x] Add a dual-theme run (e.g., parameterized test or second project) and snapshot/DOM assertions to verify styling. (AC: 4)
- [x] Ensure teardown closes browsers and clears temp profiles; guard against dangling processes in CI. (AC: 5)
- [x] Update `pnpm` scripts and GitHub Actions E2E workflow to run the richer suite (both locally and on CI). (AC: 5)
- [x] Document how to run/debug the scenarios in `docs/dev/e2e.md` (or create if missing).

## Dev Notes

- Reuse the existing Playwright launcher but allow overriding seed data through environment variables or fixtures so scenarios control inputs precisely.
- Prefer data-test attributes on popup/options elements for stable selectors; add as needed.
- When mutating rules via the UI, wait for storage flush promises before asserting popup results to avoid race conditions.
- Capture console/network logs during failures to speed up triage; consider uploading as CI artifacts.
- Keep runs under ~60s to stay CI-friendly; parallelize cautiously to avoid port conflicts with Vite.

### Testing

- `pnpm test:e2e --project=chromium-extension` (default dark mode)
- `pnpm test:e2e --project=chromium-extension-light` (optional mirror project)
- `pnpm test` to ensure unit and E2E suites can run together locally.

## Change Log

| Date       | Version | Description                                 | Author    |
| ---------- | ------- | ------------------------------------------- | --------- |
| 2025-09-23 | 0.1     | Initial draft for richer E2E coverage scope | Assistant |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
