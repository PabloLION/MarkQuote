# Story 3.1: Finish Options Page

## Status

Draft

## Story

**As a** markdown-centric researcher,
**I want** the options page to let me configure source formatting and title rules with immediate feedback,
**so that** I can trust the copied output without manually fixing it after every use.

## Acceptance Criteria

1. The options page loads a markdown template (default `> {{TEXT}}\n> Source: [{{TITLE}}]({{URL}})`) from `chrome.storage.sync`, presents it in a multiline editor with helper copy for `{{TEXT}}`, `{{TITLE}}`, and `{{URL}}`, and offers a “Restore default template” action with success/error messaging on save. [Source: docs/prd.md:33]
2. A read-only preview shows the markdown source generated from sample data using the current template and transforms, updating immediately as users edit fields. [Source: docs/prd.md:33]
3. Dedicated title and URL rule tables provide inline add/edit/remove controls for their regex search/replace pairs, validating empty inputs or invalid expressions without wiping existing rules. [Source: src/surfaces/options/controller.ts:63-143]
4. Saved options include a `version` number alongside the template and rules, and the formatter consumes the versioned payload so future migrations can run safely. [Source: src/clipboard.ts:25-52]

## Tasks / Subtasks

- [ ] Extend `public/options.html` with semantic form structure, a multiline template editor, preview panel, helper copy for `{{TEXT}}`, `{{TITLE}}`, `{{URL}}`, and a “Restore default template” control. (AC: 1, 2)
- [ ] Update `src/surfaces/options/controller.ts` to load/save a versioned payload (`version`, `format`, `titleRules`, `urlRules`), manage inline rule editing, validate regex fields, and update the preview on change. (AC: 1, 2, 3, 4)
- [ ] Share or extract formatting utilities so preview and clipboard output run through the same transform pipeline. (AC: 2, 3)
- [ ] Expand `tests/unit/options.test.ts` (plus helpers) to verify template persistence, preview updates, regex validation failures, and version stamping/reset paths. (AC: 1, 2, 3, 4)
- [ ] Document the template tokens, rule columns, and storage version contract in README.md or contributor docs. (AC: 1, 3, 4)

## Dev Notes

- **Requirements Context:** FR6 mandates a customizable source URL template with live examples; tokens are `{{TEXT}}`, `{{TITLE}}`, and `{{URL}}`. [Source: docs/prd.md:33]
- **UI Guidance:** Keep the surface minimalist and desktop-oriented; native controls satisfy current accessibility expectations. [Source: docs/prd.md:48-70]
- **Technology Constraints:** Stick with vanilla TypeScript/HTML and event listeners—no additional frameworks. [Source: docs/technical-decisions.md:5-16][Source: docs/ui-architecture.md:24-154]
- **Current UI Baseline:** `public/options.html` offers simple rule inputs but lacks template editor, preview, URL transforms, and versioning. [Source: public/options.html:77-101]
- **Existing Logic:** `initializeOptions` uses `chrome.storage.sync` for rule arrays without inline editing or version stamps; extend it to handle URL transforms and new schema. [Source: src/surfaces/options/controller.ts:7-164]
- **Clipboard Contract:** `formatForClipboard` reads `format` and rules, applies title transforms, and composes markdown—update it to honour URL transforms and versioned payloads so preview and runtime stay aligned. [Source: src/clipboard.ts:20-52]
- **Testing Baseline:** Current Vitest spec covers rule persistence; add cases for template edits, preview output, URL transforms, and version metadata. [Source: tests/unit/options.test.ts:9-62]

### Testing

- Unit tests live under `tests/unit` with jsdom; extend `options.test.ts` to assert template edits, preview output, regex errors, and version stamping. [Source: docs/ui-architecture.md:24-154][Source: tests/unit/options.test.ts:9-62]
- Continue mocking `chrome.storage` with `sinon-chrome` to verify persisted payloads and error flows. [Source: tests/unit/options.test.ts:34-61]
- Optional: add a Playwright smoke case once the dev server renders the options page with the new editor. [Source: docs/dev/plans/20250923-e2e-review.md]

## Change Log

| Date       | Version | Description                                             | Author    |
| ---------- | ------- | ------------------------------------------------------- | --------- |
| 2025-09-23 | 0.2     | Updated template, transform rules, and versioning scope | Assistant |
| 2025-09-23 | 0.1     | Initial draft                                           | Assistant |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
