# Story 3.1: Finish Options Page

## Status
Draft

## Story
**As a** markdown-centric researcher,
**I want** the options page to let me configure source formatting and title rules with immediate feedback,
**so that** I can trust the copied output without manually fixing it after every use.

## Acceptance Criteria
1. The options UI loads the saved `format` template and `titleRules` from `chrome.storage.sync`, displays them in labeled controls, and persists updates with success/failure messaging; a control restores the default `> Source: [{{title}}]({{url}})` template when requested. [Source: src/clipboard.ts:25-52]
2. A live preview panel renders a sample Markdown blockquote using the current template, sample selection text, and the first matching rule, updating on input changes without page reload. [Source: docs/prd.md:33]
3. Users can add, edit, and remove title transformation rules inline with validation for empty fields and invalid regular expressions; errors are surfaced near the offending control without breaking existing rules. [Source: src/options.ts:63-143]
4. The options page meets the PRD usability guidance: all controls are keyboard accessible with associated labels, layout adapts to light/dark schemes, and help copy explains how placeholders work and where to configure keyboard shortcuts. [Source: docs/prd.md:38-70]

## Tasks / Subtasks
- [ ] Extend `public/options.html` with semantic form structure, labeled inputs for the format template, preview area, and contextual help copy; include a button to restore defaults. (AC: 1, 2, 4)
- [ ] Update `src/options.ts` to load/save the `format` field alongside `titleRules`, manage inline editing, validate inputs, and drive the preview rendering loop. (AC: 1, 2, 3)
- [ ] Reuse or extract formatting utilities so the preview mirrors `formatForClipboard` behaviour without duplicating logic. (AC: 2)
- [ ] Enhance styling to respect prefers-color-scheme and focus states while keeping the page accessible. (AC: 4)
- [ ] Expand `tests/unit/options.test.ts` (and add new helpers if needed) to cover format persistence, preview updates, rule validation, and reset behaviour. (AC: 1, 2, 3)
- [ ] Document the format placeholders and rule expectations in `README.md` or existing docs, noting the new preview behaviour. (AC: 4)

## Dev Notes
- **Requirements Context:** FR6 mandates a customizable source link template with real-time examples on the options page. [Source: docs/prd.md:33]
- **UI Guidance:** The options page must remain minimalist, accessible, and desktop-friendly per the PRD UI goals. [Source: docs/prd.md:48-70]
- **Technology Constraints:** The options page should stay in vanilla TypeScript/HTML with event listeners for interactivity; no frameworks are planned. [Source: docs/technical-decisions.md:5-16][Source: docs/ui-architecture.md:21-29]
- **Current UI Baseline:** `public/options.html` already includes title rule inputs but lacks format controls, preview, and accessible labelling. [Source: public/options.html:77-101]
- **Existing Logic:** `initializeOptions` handles rule storage via `chrome.storage.sync`, but only for add/reset/save and render-only rows. [Source: src/options.ts:7-164]
- **Clipboard Contract:** `formatForClipboard` pulls both `format` and `titleRules`, applies regex replacements, and builds the final Markdown. The options UI must keep these keys synchronized. [Source: src/clipboard.ts:20-52]
- **Testing Baseline:** Current unit coverage verifies rule persistence via the DOM. Tests need to expand with additional DOM fixtures and storage expectations. [Source: tests/unit/options.test.ts:9-62]

### Testing
- Unit tests live under `tests/unit` and use Vitest with jsdom; mirror the options filename for new specs. [Source: docs/ui-architecture.md:26-29][Source: tests/unit/options.test.ts:9-62]
- Validate storage interactions with `sinon-chrome` mocks, as demonstrated in the existing options test. [Source: tests/unit/options.test.ts:34-61]
- Consider adding integration coverage via Playwright once the preview relies on the dev server (optional if unit tests capture DOM changes). [Source: docs/dev/plans/20250923-e2e-review.md]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-23 | 0.1 | Initial draft | Assistant |

## Dev Agent Record
### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results
_TBD_
