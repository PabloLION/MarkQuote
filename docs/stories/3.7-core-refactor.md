# Story 3.7 – Core Refactor & Tooling Cleanup

## Overview

Story 3.7 focuses on tightening the architecture and tooling for MarkQuote. The key outcomes are:

- All automation and packaging scripts run as TypeScript through `tsx`, removing lingering shell or plain-node scripts.
- Ensure unit tests consistently rely on `sinon-chrome` and remove any bespoke Chrome stubs.
- Centralize shared CSS so popup/options surfaces inherit from one source of truth.
- Break apart large modules (notably `src/background.ts`) into focused submodules to improve readability and encourage single-responsibility composition.

## Motivation

Recent UX changes surfaced readability and maintenance pain:

- `src/background.ts` now orchestrates hotkey handling, copy pipelines, E2E helpers, and error logging. This monolith is hard to reason about and blocks further features.
- Scripts under `scripts/` are a mix of shell, JS, and TS. We want consistent tooling, easier type checking, and cross-platform parity via `tsx`.
- Popup and options HTML duplicate styling, making visual tweaks error-prone.
- The team already standardized on `sinon-chrome`; this story validates the entire suite and purges any stragglers.

## Deliverables

1. **Documentation & Tracking**

   - Update this story doc as milestones land.
   - Note follow-up tasks if the refactor exposes additional debt.

2. **Script Migration to TypeScript**

   - Audit `scripts/` and `package.json` commands.
   - Convert remaining shell/JS scripts to `.ts` modules.
   - Swap execution to `tsx` (ensure shebangs or npm scripts use `tsx` directly).
   - Update lint/format hooks to cover the new files.

3. **Sinon Chrome Verification**

   - Confirm all unit tests import `sinon-chrome`.
   - Remove custom Chrome mocks or polyfills.
   - Document the convention in `docs/dev` if gaps remain.

4. **Shared CSS Extraction**

   - Identify overlapping rules in `public/popup.html` and `public/options.html`.
   - Create a shared stylesheet (e.g., `public/styles/shared.css`) and reference it from both surfaces.
   - Ensure Vitest/jsdom fixtures mimic the new structure.

5. **Module Decomposition**

   - Target `src/background.ts` first: introduce `src/background/` folder with files such as `copy-pipeline.ts`, `hotkey.ts`, `errors.ts`, etc.
   - Apply the same discipline to other oversized modules (popup/options) where beneficial.
   - Maintain public exports so build outputs remain stable.

6. **Testing**
   - Keep `pnpm test` and `pnpm exec playwright test --project=chromium-extension` green after each major checkpoint.
   - Add regression tests when refactors change behavior (e.g., new module boundaries, CSS refactor).

## Acceptance Criteria

- All scripts run via `tsx` and compile as TypeScript.
- No unit test imports plain Chrome mocks; all rely on `sinon-chrome`.
- Popup/options share extracted CSS without visual regressions.
- `src/background.ts` (and other large files identified during the story) are reorganized into smaller modules while preserving functionality.
- CI commands remain green.

## Risks & Mitigations

- **Large refactor churn**: break work into commits per subsystem (scripts → CSS → background) and run tests between each.
- **Packaging side-effects**: after script conversion, run `pnpm build` and smoke-test extension loading.
- **CSS regressions**: capture before/after screenshots or rely on Playwright visual checks.
- **E2E helpers**: ensure background refactor keeps E2E messaging (`e2e:prime-selection`, `e2e:set-options`) intact.

## Follow-Up Considerations

- Once TypeScript-only scripts work, consider enabling `tsc --noEmit` in CI.
- Evaluate further decomposition (e.g., options form handlers) after the background split.
- Document coding standards for future scripts/modules to prevent regressions.
