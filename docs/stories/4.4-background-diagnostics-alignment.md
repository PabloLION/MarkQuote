# Story 4.4 - Background Naming & Initialization Alignment

**Status:** Done
**Depends on:** Story 4.5 (Runtime Constants)

## Overview

Bring the background service naming and initialization flows in line with their
current responsibilities. The legacy names (`ensureOptionsInitialized`,
`triggerCopy`) no longer reflect what the functions actually do, and ad-hoc
resets leave caches (preview text, diagnostics) populated after integration
tests. This confusion contributed to recent regressions and makes onboarding
harder.

## Objectives

- Rename `ensureOptionsInitialized` to something that captures both
  initialization and migration (e.g., `initializeOrMigrateOptions`) and update
  documentation accordingly.
- Rename `triggerCopy` to a handler-oriented name (e.g., `handleCopyRequest`)
  and break orchestration pieces into smaller helpers.
- Centralize reset behavior so preview caches, diagnostics, and forced overrides
  are cleared consistently.
- Ensure each rename includes exhaustive TypeScript refactors, logging updates,
  and test adjustments.

## Deliverables

- Updated background modules with the new function names and extracted helpers.
- Revised tests (unit + E2E) referencing the renamed functions.
- Documentation updates in story file explaining the revised flows.

## Acceptance Criteria

- [x] Background build passes with the new names and there are no lingering
      references to the deprecated identifiers
- [x] `ensureOptionsInitialized` → `initializeOrMigrateOptions`
- [x] `triggerCopy` → `handleCopyRequest`
- [x] Reset flows clear preview caches, diagnostics, and forced overrides,
      verified by tests (via `resetExtensionState`)
- [x] Documentation and inline comments describe the responsibilities of the
      refactored helpers
- [x] No orphaned error states after extension reload
- [x] Unit tests cover reset flow edge cases
- [x] All 282 unit tests pass
- [x] E2E tests pass

## Implementation Summary

### Commit 1: Rename `ensureOptionsInitialized` → `initializeOrMigrateOptions`

The new name better reflects the function's dual responsibility:

- First-run initialization with default options
- Migration from prior schema versions

Files updated:

- `src/background/options-persistence.ts` (definition)
- `src/background/context-menus.ts` (type and usage)
- `src/background/index.ts` (import and usages)

### Commit 2: Rename `triggerCopy` → `handleCopyRequest`

The new name better reflects the function's role as a request handler that
orchestrates the copy flow, rather than just triggering an action.

Files updated:

- `src/background/index.ts` (definition and internal calls)
- `src/background/context-menus.ts` (type and usage)
- `src/background/e2e.ts` (type and usage)
- `tests/unit/background.e2e.test.ts` (mock names)

### Reset Behavior

The `resetExtensionState` function in `index.ts` already centralizes reset
behavior properly:

- Clears pending copy sources
- Resets hotkey fallback state
- Resets popup document ID and state
- Clears preview errors and E2E preview state
- Resets hotkey diagnostics and forced pinned state
- Clears session and sync storage
- Clears stored errors
- Re-initializes options

## Technical Notes

- Used TypeScript refactoring for safe symbol renames
- Updated all logging statements to use new function names
- The `resetExtensionState` function was already well-structured; no additional
  extraction needed

## Risks & Mitigations

- **Refactor scope creep:** Constrained work to naming/structure changes without
  altering behavior; verified with full test suite
- **Extension lifecycle quirks:** Verified context menu and hotkey flows still
  initialize options after rename
- **Doc drift:** Updated story file with implementation details

## References

- Supersedes: `docs/stories/backlog/background-initialization-alignment.md`
- Related: Story 4.3 (Diagnostics), Story 4.5 (Constants)
