# Story 4.4 - Background Naming & Initialization Alignment

**Status:** Not Started
**Depends on:** Story 4.5 (Runtime Constants)

## Overview

Bring the background service naming and initialization flows in line with their
current responsibilities. The legacy names (`ensureOptionsInitialized`,
`triggerCopy`) no longer reflect what the functions actually do, and ad-hoc
resets leave caches (preview text, diagnostics) populated after integration
tests. This confusion contributed to recent regressions and makes onboarding
harder.

## Objectives

- Rename `ensureOptionsInitialized` to something that captures both
  initialization and migration (e.g., `initializeOrMigrateOptions`) and update
  documentation accordingly.
- Rename `triggerCopy` to a handler-oriented name (e.g., `handleCopyRequest`)
  and break orchestration pieces into smaller helpers.
- Centralize reset behavior so preview caches, diagnostics, and forced overrides
  are cleared consistently.
- Ensure each rename includes exhaustive TypeScript refactors, logging updates,
  and test adjustments.

## Deliverables

- Updated background modules with the new function names and extracted helpers.
- Revised tests (unit + E2E) referencing the renamed functions.
- Documentation updates (`docs/dev/options-migrations.md`,
  `docs/dev/test-coverage.md`, etc.) that explain the revised flows.
- Changelog entry noting the refactor for future contributors.

## Acceptance Criteria

- [ ] Background build passes with the new names and there are no lingering
      references to the deprecated identifiers
- [ ] `ensureOptionsInitialized` → `initializeOrMigrateOptions` (or similar)
- [ ] `triggerCopy` → `handleCopyRequest` (or similar)
- [ ] Reset flows clear preview caches, diagnostics, and forced overrides,
      verified by tests
- [ ] Documentation and inline comments describe the responsibilities of the
      refactored helpers
- [ ] No orphaned error states after extension reload
- [ ] Unit tests cover reset flow edge cases

## Technical Notes

- Use TypeScript's rename symbol feature for safe refactoring
- Update all logging statements to use new function names
- Consider extracting: `buildMarkdownOutput`, `writeToClipboard`,
  `updateBadgeState` as separate helpers from the main handler

## Risks & Mitigations

- **Refactor scope creep:** Constrain the work to naming/structure changes
  without altering behavior; add regression tests before extracting helpers
- **Extension lifecycle quirks:** Manually verify context menu and hotkey flows
  still initialize options after the rename
- **Doc drift:** Double-check references in onboarding docs and diagrams after
  renaming

## References

- Supersedes: `docs/stories/backlog/background-initialization-alignment.md`
- Related: Story 4.3 (Diagnostics), Story 4.5 (Constants)
