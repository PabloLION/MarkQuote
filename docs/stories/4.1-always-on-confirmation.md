# Story 4.1 - Always-On Confirmation Toggle

**Status:** Done
**Depends on:** Story 4.2 (Feedback UX), Story 4.3 (Diagnostics)
**Priority:** Last (flagship feature, requires other stories complete)

## Overview

When users trigger copy via keyboard shortcut (Alt+C) or context menu, they
currently get no visual feedback unless the extension icon is pinned and they
click it. This story adds a user preference to automatically show the popup
after any copy action, using the `chrome.action.openPopup()` API.

## Problem

Users copying via hotkey or context menu have no way to confirm the copy
succeeded or see the formatted preview without manually clicking the extension
icon. This creates uncertainty about whether the copy worked.

## Solution

Use `chrome.action.openPopup()` API to programmatically open the popup after
copy actions, showing the formatted preview and success/error status.

## Technical Notes

- `chrome.action.openPopup()` works for unpinned extensions (Chrome 127+)
- No longer requires user gesture or policy installation
- **Critical:** Cannot be called from popup windows (causes crash) - only from
  background script
- User preference toggle: "Always show confirmation after copy"
- Stored in `chrome.storage.sync` for cross-device sync
- Must wait for copy operation to complete before opening popup

## Acceptance Criteria

- [x] Add "Always show confirmation" toggle to options page
- [x] Store preference in `chrome.storage.sync` with schema migration
- [x] After hotkey copy, open popup automatically if preference enabled
- [x] After context menu copy, open popup automatically if preference enabled
- [x] Popup displays the same preview/status as manual open
- [x] Toggle default is OFF to preserve current behavior
- [x] Works with unpinned extension icon
- [x] Graceful degradation for Chrome < 127 (feature disabled, no errors)
- [ ] E2E tests verify automatic popup behavior (deferred - requires browser
  automation of popup opening which is complex to test reliably)

## UI Changes

### Options Page

- New section or checkbox: "Show confirmation popup after copying"
- Help text: "Automatically opens the popup to show your copied content after
  using keyboard shortcut or right-click menu"

### Popup

- No changes needed (reuses existing preview/status UI)

## Risks & Mitigations

- **Chrome version requirement:** Feature-detect `chrome.action.openPopup` and
  gracefully degrade; hide toggle on unsupported versions
- **Popup crash:** Never call `openPopup()` from within popup context; add
  runtime guard
- **User annoyance:** Default OFF, let users opt-in
- **Timing issues:** Ensure copy completes before opening popup

## Implementation

### Schema Changes (`src/options-schema.ts`)

- Bumped `CURRENT_OPTIONS_VERSION` from 3 to 4
- Added `showConfirmationPopup: boolean` to `OptionsPayload` interface
- Added field to `DEFAULT_OPTIONS` with default value `false`
- Updated `normalizeStoredOptions()` to migrate existing users (default false)
- Updated `OptionsLike` interface for type safety

### Persistence (`src/background/options-persistence.ts`)

- Updated all `storageArea.set()` calls to include `showConfirmationPopup`
- Field syncs across devices via `chrome.storage.sync`

### Options UI (`public/options.html`, `src/surfaces/options/`)

- Added new "Settings" section with checkbox toggle
- Checkbox wired to draft state via change handler
- State loaded from storage on page load
- Saved with form submission

### Background Logic (`src/background/index.ts`)

- `supportsOpenPopup()`: Feature detection for Chrome 127+
- `maybeOpenConfirmationPopup()`: Reads preference and opens popup if enabled
- Called after `runCopyPipeline()` for non-popup sources (hotkey/context-menu)
- Gracefully handles API unavailability and popup open failures

## References

- [chrome.action.openPopup() API](https://developer.chrome.com/docs/extensions/reference/api/action#method-openPopup)
- [W3C WebExtensions Issue #160](https://github.com/w3c/webextensions/issues/160)
- Depends on: Story 4.2 (Feedback UX refresh), Story 4.3 (Diagnostics)
