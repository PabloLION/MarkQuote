# Story 3.9 – End-to-End Coverage Expansion

## Overview

Story 3.9 extends the Playwright suite so it mirrors the core user journeys we expect in production. The current coverage validates basic popup launch and rule editing, but key workflows—like hotkey flows, context menu copying, protected-page handling, and error recovery—remain untested. This story designs those scenarios, introduces the fixtures required to exercise them, and documents how contributors should iterate on E2E tests going forward.

## Objectives

- Catalogue the primary user journeys for MarkQuote (popup invoke, context menu copy, hotkey fallback, options rule failure, error log maintenance, first-run onboarding).
- Design Playwright specs that cover each journey end-to-end, including both success and failure branches.
- Standardise test data/fixtures so scenarios reuse helpers instead of duplicating boilerplate.
- Ensure E2E runs remain deterministic by tightening background synchronisation helpers.
- Document the new flows so contributors can add future scenarios without regressing reliability.

## Candidate Flows

1. **Popup → Markdown preview (success & clipboard fallback)**
   - Selection injection, preview render, clipboard write success/failure.
2. **Hotkey shortcut**
   - Pinned action → popup-ready message → queued fallback timeout; includes popup crash/close race.
3. **Context menu capture**
   - Selection in a tab, context menu action, protected URL warning.
4. **Rule management**
   - Options form validation failure, drag-and-drop reorder success, keyboard accessibility path.
5. **Error log lifecycle**
   - Inject background error, confirm badge updates, clear log via popup.
6. **First-run onboarding**
   - No stored options; ensure defaults load and copy still succeeds.

## Deliverables

- Updated Playwright specs that cover the flows above (new files or expanded suites where appropriate).
- Additional helpers/fixtures for hotkey fallback timing, context menu invocation, and badge assertions.
- Test data seeds for options/rule permutations (prefer JSON fixtures under `tests/e2e/fixtures/`).
- Documentation updates (`tests/e2e/README.md`) describing scenarios, helper usage, and debugging tips.
- CI guidance if runtime length increases (e.g., parallelism tweaks, selective `--grep` usage).

## Acceptance Criteria

- `pnpm test:e2e` executes the expanded suite within an acceptable runtime (<5 minutes locally, <8 minutes in CI).
- Each user flow identified above has at least one deterministic Playwright spec covering both success and expected failure handling.
- New helpers include defensive waits/logging to keep flakes <1% across repeated runs.
- README updates explain how to add / run the new flow-specific specs.
- All new tests pass against Chromium with `VITE_E2E=true` builds.

## Risks & Mitigations

- **Service worker timing**: rely on background message probes or reuse the popup-ready queue to synchronise flows.
- **Context menu limitations**: may require loading a dedicated test page and enabling extension action contexts; document any Chrome quirks.
- **Runtime inflation**: group related flows into nested `describe` blocks and use `test.step` to keep diagnostics focused.
- **Fixture drift**: centralise routed content fixtures so updates don’t require editing multiple specs.

## Open Questions

- Do we need visual regression captures (screenshots) for major flows, or is DOM assertion sufficient?
- Should hotkey coverage run in headless mode, or do we enforce headed runs for reliability?
- Are there browser-specific behaviours (Firefox, Edge) we should anticipate for future matrix testing?
