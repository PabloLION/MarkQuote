# Story 3.4: Optimize Manifest & Publishing Flow

## Status
Draft

## Story
**As a** maintainer preparing for public release,
**I want** a minimal-permission manifest and a documented publishing checklist,
**so that** the extension ships with least-privilege defaults and a repeatable submission process.

## Acceptance Criteria
1. `manifest.json` requests only the permissions/site access required for runtime features (popup/context menu copy, options storage, clipboard pipeline).
2. Manifest site access defaults to "on click" (or equivalent minimal scope) without breaking copy flows.
3. Development and E2E tooling operate without hidden manifest overrides.
4. Publishing workflow is documented end-to-end (build/QA commands, asset prep, store submission steps).
5. All unit and Playwright suites pass after changes.

## Scope & Approach
### Manifest Review
- Current permissions: `contextMenus`, `activeTab`, `scripting`, `storage`.
- Investigate dropping or refactoring:
  - `scripting`: injected from background via `chrome.scripting.executeScript`; could be replaced by declarative or popup-side injection.
  - `tabs`: removed after verifying `chrome.tabs.query` works for the active tab under the `activeTab` grant.
  - `clipboardWrite`: confirmed unnecessary because clipboard writes happen inside the popup with a user gesture.
  - `tabs`: primarily used to open `chrome://extensions/shortcuts` and external feedback/issue pages; confirm necessity.
- Site access: remove `<all_urls>` content script if unused; rely on on-demand execution tied to user gestures.

### Testing Tooling
- Update Playwright harness so no manual host permission edits are required (reuse on-click gesture or mock page served from dev server).
- Ensure `pnpm dev` flow still serves the dev surfaces without elevated permissions.

### Publishing Checklist
Capture in-story documentation (replacing separate docs):
- **Prereqs:** developer account, version bump, icons/screenshots ready.
- **Build/QA:**
  - `pnpm install`
  - `pnpm tsc --noEmit`
  - `pnpm test`
  - `pnpm test:e2e`
  - `pnpm build`
  - Manual smoke: load `dist/`, verify popup/context menu/shortcut/options on real sites.
- **Packaging:** `cd dist && zip -r ../markquote-v<version>.zip .`.
- **Store Listing:** refresh screenshots, description, privacy/support links.
- **Submission:** upload ZIP, set release notes, regions, submit for review.
- **Post-Release:** tag repo, publish release notes, monitor store feedback.

## Tasks
- [ ] Prototype manifest changes with least-privilege permissions.
- [ ] Adjust background/popup flow to work without `offscreen` (use popup clipboard) and reassess `scripting` necessity.
- [ ] Simplify Playwright setup to rely on production manifest only.
- [ ] Validate with `pnpm test`, `pnpm test:e2e`, and manual smoke.
- [ ] Update README/CHANGELOG if permission set changes.
- [ ] Finalize publishing checklist details (versions, assets) once manifest is locked.

## QA Notes
- Confirm popup/context menu copy works on arbitrary HTTPS page with new manifest/site access.
- Verify keyboard shortcut behaves under revised permissions.
- Ensure clipboard copy is still reliable (no errors in background logs).
- Run Playwright suite; trace any failures back to manifest restrictions.
