# Story 3.4: Optimize Manifest & Publishing Flow

## Status

Completed

## Story

**As a** maintainer preparing for public release,
**I want** a minimal-permission manifest and a documented publishing checklist,
**so that** the extension ships with least-privilege defaults and a repeatable submission process.

## Acceptance Criteria

1. `manifest.json` requests only the permissions/site access required for runtime features (popup/context menu copy, options storage, clipboard pipeline).
2. Manifest site access defaults to "on click" (or equivalent minimal scope) without breaking copy flows.
3. Development and E2E tooling operate without hidden manifest overrides.
4. Publishing workflow is documented end-to-end (build/QA commands, asset prep, store submission steps).
5. All unit and Playwright suites pass after changes.

## Scope & Approach

### Manifest Review

- Final permissions: `contextMenus`, `activeTab`, `scripting`, `storage`, `windows` (retained for popup fallback window focus).
- `clipboardWrite`: dropped once copy moved into the popup (user gesture context keeps writes allowed).
- `tabs`: dropped after confirming the workflow only needs `chrome.tabs.query`/`create` under the `activeTab` grant.
- `scripting`: retained; still required to inject `selection.js` until we replace the runtime injection model.
- Site access: no host permissions requested; runtime execution depends on user gestures (toolbar, context menu, command).

### Testing Tooling

- Update Playwright harness so no manual host permission edits are required (reuse on-click gesture or mock page served from dev server).
- Ensure `pnpm dev` flow still serves the dev surfaces without elevated permissions.

### Publishing Checklist

- Final copy lives in `docs/dev/publishing-checklist.md` (covers prereqs, build/QA, packaging, listing, submission, post-release, rollback).

## Tasks

- [x] Prototype manifest changes with least-privilege permissions.
- [x] Adjust background/popup flow to work without `offscreen` (use popup clipboard) and reassess `scripting` necessity.
- [x] Simplify Playwright setup to rely on production manifest only.
- [x] Validate with `pnpm test`, `pnpm test:e2e`, and manual smoke.
- [x] Update README/CHANGELOG if permission set changes.
- [x] Finalize publishing checklist details (versions, assets) once manifest is locked.

## Decisions & Progress

- `clipboardWrite` permission removed—clipboard writes now rely on the popup’s user-facing context and succeed in unit/E2E runs.
- `tabs` permission removed—`chrome.tabs.query` continues to work for the active tab through the `activeTab` grant, confirmed via Playwright regression suite.
- Minimal permission set is now `contextMenus`, `activeTab`, `scripting`, `storage`; any further reduction would require replacing the `chrome.scripting.executeScript` pipeline.
- Publishing checklist now captured in `docs/dev/publishing-checklist.md`.

## QA Notes

- Confirmed popup/context menu copy works on arbitrary HTTPS page with the least-privilege permissions.
- Verified keyboard shortcut behaviour and clipboard writes via smoke test after `pnpm build`.
- `pnpm test`, `pnpm test:e2e`, and manual smoke runs pass without manifest-related regressions.
