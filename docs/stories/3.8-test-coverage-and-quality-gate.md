# Story 3.8 – Test Coverage & Quality Gate

## Overview

Story 3.8 focuses on hardening our automated test bed ahead of the 1.1.0 release. We will expand Vitest coverage, lock in minimum coverage thresholds, and stabilize the Playwright extension flows so we can trust the release pipeline. The story begins from a failing e2e run ("Unknown Chrome runtime error") and a lack of explicit coverage enforcement.

## Objectives

- Diagnose and fix the popup preview regression currently breaking Playwright specs.
- Add targeted unit tests for areas with low coverage (background orchestration, rule validation edge cases, clipboard fallbacks).
- Introduce development dependencies and configuration needed to generate reliable HTML/LCOV coverage reports.
- Enforce a project-wide coverage floor (target ≥80% statements/lines) in Vitest and wire it into local + CI scripts.
- Document the new quality gate so future stories know how to keep it green.

## Deliverables

1. **Stability fixes**
   - Identify the root cause of the popup preview error surfaced by Playwright and close the gap with tests.
   - Ensure selection → clipboard pipeline works in light/dark themes and hotkey flows.
2. **Coverage expansion**
   - Add unit specs that exercise background fallback timers, session persistence, and error logging branches.
   - Cover options rule manipulation (drag/drop abort, bounds checks) and popup messaging fallbacks.
3. **Quality gate tooling**
   - Add coverage reporter dependencies (e.g., `@vitest/coverage-v8`) and configure `vitest.config.ts` thresholds.
   - Update npm scripts so `pnpm test:coverage` emits reports and fails when thresholds are missed.
   - Export coverage artifacts through Playwright when running end-to-end for debugging.
4. **Documentation**
   - Summarize coverage expectations in `docs/dev/testing.md` and record progress in this story file.

## Acceptance Criteria

- `pnpm test` and `pnpm test:e2e` pass reliably on the branch and in CI.
- `pnpm test:coverage` fails when coverage drops below the agreed thresholds (≥80%).
- Coverage report shows meaningful increases across `src/background`, `src/surfaces/options`, and `src/surfaces/popup` modules.
- Story doc captures key changes, lingering gaps, and follow-up ideas.

## Risks & Mitigations

- **Flaky service worker timing:** add deterministic waits or background message polling in Playwright. Consider exposing debug hooks under `VITE_E2E` when necessary.
- **Slow coverage runs:** keep unit coverage as the gate; only run Playwright with coverage artifacts on demand.
- **Drag/drop complexity:** if DOM APIs prove hard to simulate, fall back to helper functions and unit-test their logic directly.
