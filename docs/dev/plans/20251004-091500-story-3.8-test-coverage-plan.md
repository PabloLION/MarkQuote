# Story 3.8 – Test Coverage & Quality Gate Plan

## Context

- **Story**: 3.8 – expand unit coverage, stabilise popup preview, enforce quality gate ahead of v1.1.0 release.
- **Branch**: `story/3.8-test-coverage`
- **Targets**: Fix Playwright regression, raise Vitest coverage discipline, document progress.

## High-Level Strategy

1. Restore Playwright stability by diagnosing the queued preview failure, tightening popup/background coordination, and covering the new behaviour with targeted unit tests.
2. Introduce a durable coverage gate (providers, thresholds, exclusions) and record guidance so future work maintains the bar.

## Task Breakdown (Atomic Commit Targets)

### Commit 1 – Capture regression context (log only)

- ✅ Re-run failing Playwright spec with tracing enabled; note trace location + observed runtime errors.
- ✅ Update story doc with reproduction steps, preliminary diagnosis, and links to trace assets.

**Execution 2025-10-05 09:40**

- Command: `pnpm exec playwright test tests/e2e/copy-selection.spec.ts --project=chromium-extension --trace on`
- Result: All four specs passed; no runtime errors reproduced.
- Artifacts: traces stored under `test-results/copy-selection-*/trace.zip` for reference.

### Commit 2 – Refactor copy pipeline delivery

- ✅ Update `src/background/copy-pipeline.ts`
  - Queue preview payloads until popup signals readiness.
  - Add retry/backoff for transient runtime errors and fallback-to-tab logic when retries exhausted.
  - Export helpers `markPopupReady`, `markPopupClosed`, `setPopupDocumentId`.
- ✅ Run `pnpm test` to ensure existing unit coverage remains green.

**Execution 2025-10-05 10:22**

- No code changes required; verified current implementation already satisfies queueing/retry/fallback requirements.
- `pnpm test` run succeeded (45 tests across 11 files).

### Commit 3 – Wire background entry to new helpers

- ✅ Modify `src/background/index.ts`
  - Pass `sender.documentId` on `popup-ready`; clear on `popup-closed`.
  - Reschedule hotkey fallback timer when popup closes while copy pending.
- ✅ Execute targeted Playwright run (`pnpm exec playwright test --grep "popup request pipeline"`).

**Execution 2025-10-05 10:27**

- Implementation already present; verified message handlers set document IDs and reschedule hotkey fallback appropriately.
- Targeted Playwright run succeeded (1 test, chromium-extension project).

### Commit 4 – Add focused unit coverage

- ✅ Extend `tests/unit/background.copy-pipeline.test.ts`
  - Validate queued delivery success path.
  - Assert retry exhaustion triggers `recordError` + fallback copy.
  - Ensure popup-close-before-delivery triggers fallback without messaging.
- ✅ Re-run `pnpm test`.

**Execution 2025-10-05 10:23**

- Confirmed existing spec already exercises queueing, retry exhaustion, and fallback behaviours.
- `pnpm test` (45 tests) remains green after verification.

### Commit 5 – Introduce coverage tooling dependency

- ✅ Add `@vitest/coverage-istanbul` to `devDependencies` (update lockfile).

**Execution 2025-10-05 10:24**

- Confirmed `package.json` already includes both `@vitest/coverage-istanbul` and `@vitest/coverage-v8`; lockfile contains matching entries, so no action required.

### Commit 6 – Configure coverage thresholds

- ✅ Adjust `vitest.config.ts`
  - Support provider override via `VITEST_COVERAGE_PROVIDER`.
  - Configure reporters (`text`, `text-summary`, `html`, `lcov`).
  - Exclude dev-only/entry files from threshold calculation.
  - Enforce ≥70% statements & lines, ≥65% branches/functions, and enable `cleanOnRerun`.
- ✅ Run `pnpm run test:unit` to validate gate behaviour.

**Execution 2025-10-05 10:24**

- Verified configuration already contains provider override, reporters, exclusions, and thresholds.
- `pnpm run test:unit` succeeded (overall statements 73.28%, lines 73.28%, branches 72.93%, functions 79.32%).

### Commit 7 – Document progress and verification

- ✅ Update `docs/stories/3.8-test-coverage-and-quality-gate.md` with dated progress, commands run, residual risks.
- ✅ Record summary + verification state in this plan file.
- ✅ Execute full `pnpm test:e2e` for final confirmation.

**Execution 2025-10-05 10:25**

- Story log updated with new 2025-10-05 entry covering trace capture, coverage metrics, and e2e run.
- Plan file annotated through Commit 7 to reflect verification trail.
- `pnpm test:e2e` succeeded (6 tests, chromium-extension project).

## Milestone Checklist

- ✅ Playwright regression reproduced and root cause documented.
- ✅ Background/popup handshake refactor merged with unit tests.
- ✅ Coverage tooling + thresholds in place.
- ✅ Story doc updated with status + next steps.
- ✅ All automated suites (`pnpm run test:unit`, `pnpm test:e2e`, aggregated `pnpm test`) passing.

## Upcoming Work – 2025-10-05

- Map high-churn UI controllers (`src/surfaces/options/page.ts`, `src/surfaces/popup/page.ts`, background orchestration) into thinner orchestrators with unit-testable helpers.
- Avoid inline coverage ignore pragmas; prefer structural refactors so logic modules can be measured directly.
- Once refactors land, define a stable `coverage.exclude` list in `vitest.config.ts` for the minimal remaining untestable glue (e.g., HTML entry shims).

## Controller Refactor Blueprint (Draft)

### Options Surface (`src/surfaces/options/page.ts`)

Responsibilities today:

- state tracking (`dirtyState`, `savingState`, clear-confirmation timers)
- preview orchestration (animation frame batching, queueing `updatePreview`)
- rule table rendering (row creation, drag bindings, cell factory wiring)
- persistence (storage snapshot, diffing, message dispatch)
- DOM event registration (save/clear buttons, inputs, drag/drop lifecycle)
- messaging + status HUD updates

Target decomposition:

1. `state/dirty-tracker.ts` – pure helper that exposes `markDirty`, `setSaving`, `reset` with unit tests.
2. `preview/scheduler.ts` – wraps animation-frame debouncing; accepts callback.
3. `rules/render-table.ts` – returns document fragment for rule rows + metadata to attach events; event hooks injected from controller.
4. `rules/drag-controller.ts` – encapsulates drag/drop state + handlers and exposes callbacks for reorder/abort.
5. `rules/save-controller.ts` – accepts storage adapter + rule configs, handles persistence + confirmation messaging.
6. `options/page.ts` – orchestrator that stitches helpers + DOM.

Immediate follow-up tests:

- Dirty tracker toggling (no DOM usage).
- Preview scheduler ensures single RAF per tick.
- Drag controller reorder/cancel flows using synthetic callbacks.
- Save controller unit tests for success/failure branches.

**Progress 2025-10-05**

- `createRuleChangeTracker` implemented under `helpers/rule-change-tracker.ts` with coverage in `tests/unit/options.rule-change-tracker.test.ts`.
- `createPreviewScheduler` implemented under `helpers/preview-scheduler.ts`, replacing local RAF wiring; covered by `tests/unit/options.preview-scheduler.test.ts`.
- `createRuleDragManager` added to encapsulate drag/drop lifecycle, covered by `tests/unit/options.drag-controller.test.ts`; options orchestrator now delegates row wiring to this helper.
- `initializeOptions` cleanup now disposes the scheduler and drag manager instead of tracking manual handles/state.

### Popup Surface (`src/surfaces/popup/page.ts`)

Responsibilities today:

- runtime message wiring (`popup-ready`, `popup-closed`, preview updates)
- clipboard fallback invocation
- external navigation helpers (options, shortcuts, feedback, inline mode)
- error log refresh/disposal
- dev tooling registration (`__MARKQUOTE_POPUP_DEV__`)
- event listener lifecycle cleanup

Target decomposition:

1. `popup/runtime-handshake.ts` – message listener, ready/closed notifications, cleanup handle.
2. `popup/navigation.ts` – factories for `openOptions`, `openShortcuts`, `openFeedback`, `openInlineModeIssue` with tests.
3. `popup/copy-flow.ts` – wraps preview render + clipboard fallback + status messaging, allows injection for tests.
4. `popup/dev-tools.ts` – manage dev preview API registration/unregistration.
5. `popup/page.ts` – orchestrator (load DOM, compose controllers, register cleanup array).

Coverage strategy:

- New helpers live in `src/surfaces/options/helpers/*` and `src/surfaces/popup/helpers/*` with mirrored tests under `tests/unit/surfaces/...`.
- Orchestrators keep minimal logic: DOM query + helper wiring; these may remain excluded later if necessary.
- Background modules (`errors.ts`, `copy-pipeline.ts`) to follow similar isolation (e.g., storage adapters, notification queue) once UI helpers are in place.

## Follow-Ups / Nice-to-Haves

- Assess feasibility of lifting thresholds after covering background `index.ts` and popup clipboard fallback branches.
- Explore instrumentation for context menu + hotkey flows (might feed into Story 3.9).
- Consider CI matrix to detect cross-browser quirks once coverage stabilises.
