# Story 3.8 â€“ Test Coverage & Quality Gate Plan

## Context

- **Story**: 3.8 â€“ expand unit coverage, stabilise popup preview, enforce quality gate ahead of v1.1.0 release.
- **Branch**: `story/3.8-test-coverage`
- **Targets**: Fix Playwright regression, raise Vitest coverage discipline, document progress.

## High-Level Strategy

1. Restore Playwright stability by diagnosing the queued preview failure, tightening popup/background coordination, and covering the new behaviour with targeted unit tests.
2. Introduce a durable coverage gate (providers, thresholds, exclusions) and record guidance so future work maintains the bar.

## Task Breakdown (Atomic Commit Targets)

### Commit 1 â€“ Capture regression context (log only)

- â³ Re-run failing Playwright spec with tracing enabled; note trace location + observed runtime errors.
- ğŸ”„ Update story doc with reproduction steps, preliminary diagnosis, and links to trace assets.

### Commit 2 â€“ Refactor copy pipeline delivery

- ğŸ”„ Update `src/background/copy-pipeline.ts`
  - Queue preview payloads until popup signals readiness.
  - Add retry/backoff for transient runtime errors and fallback-to-tab logic when retries exhausted.
  - Export helpers `markPopupReady`, `markPopupClosed`, `setPopupDocumentId`.
- â³ Run `pnpm test` to ensure existing unit coverage remains green.

### Commit 3 â€“ Wire background entry to new helpers

- ğŸ”„ Modify `src/background/index.ts`
  - Pass `sender.documentId` on `popup-ready`; clear on `popup-closed`.
  - Reschedule hotkey fallback timer when popup closes while copy pending.
- â³ Execute targeted Playwright run (`pnpm exec playwright test --grep "popup request pipeline"`).

### Commit 4 â€“ Add focused unit coverage

- ğŸ”„ Extend `tests/unit/background.copy-pipeline.test.ts`
  - Validate queued delivery success path.
  - Assert retry exhaustion triggers `recordError` + fallback copy.
  - Ensure popup-close-before-delivery triggers fallback without messaging.
- â³ Re-run `pnpm test`.

### Commit 5 â€“ Introduce coverage tooling dependency

- ğŸ”„ Add `@vitest/coverage-istanbul` to `devDependencies` (update lockfile).

### Commit 6 â€“ Configure coverage thresholds

- ğŸ”„ Adjust `vitest.config.ts`
  - Support provider override via `VITEST_COVERAGE_PROVIDER`.
  - Configure reporters (`text`, `text-summary`, `html`, `lcov`).
  - Exclude dev-only/entry files from threshold calculation.
  - Enforce â‰¥70% statements & lines, â‰¥65% branches/functions, and enable `cleanOnRerun`.
- â³ Run `pnpm test:coverage` to validate gate behaviour.

### Commit 7 â€“ Document progress and verification

- ğŸ”„ Update `docs/stories/3.8-test-coverage-and-quality-gate.md` with dated progress, commands run, residual risks.
- ğŸ”„ Record summary + verification state in this plan file.
- â³ Execute full `pnpm test:e2e` for final confirmation.

## Milestone Checklist

- â³ Playwright regression reproduced and root cause documented.
- â³ Background/popup handshake refactor merged with unit tests.
- â³ Coverage tooling + thresholds in place.
- â³ Story doc updated with status + next steps.
- â³ All automated suites (`pnpm test`, `pnpm test:coverage`, `pnpm test:e2e`) passing.

## Follow-Ups / Nice-to-Haves

- Assess feasibility of lifting thresholds after covering background `index.ts` and popup clipboard fallback branches.
- Explore instrumentation for context menu + hotkey flows (might feed into Storyâ€¯3.9).
- Consider CI matrix to detect cross-browser quirks once coverage stabilises.
