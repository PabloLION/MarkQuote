# Story 3.8 – Test Coverage & Quality Gate Plan

## Context

- **Story**: 3.8 – expand unit coverage, stabilise popup preview, enforce quality gate ahead of v1.1.0 release.
- **Branch**: `story/3.8-test-coverage`
- **Targets**: Fix Playwright regression, raise Vitest coverage discipline, document progress.

## High-Level Strategy

1. Restore Playwright stability by diagnosing the queued preview failure, tightening popup/background coordination, and covering the new behaviour with targeted unit tests.
2. Introduce a durable coverage gate (providers, thresholds, exclusions) and record guidance so future work maintains the bar.

## Task Breakdown (Atomic Commit Targets)

### Commit 1 – Capture regression context (log only)

- ⏳ Re-run failing Playwright spec with tracing enabled; note trace location + observed runtime errors.
- 🔄 Update story doc with reproduction steps, preliminary diagnosis, and links to trace assets.

### Commit 2 – Refactor copy pipeline delivery

- 🔄 Update `src/background/copy-pipeline.ts`
  - Queue preview payloads until popup signals readiness.
  - Add retry/backoff for transient runtime errors and fallback-to-tab logic when retries exhausted.
  - Export helpers `markPopupReady`, `markPopupClosed`, `setPopupDocumentId`.
- ⏳ Run `pnpm test` to ensure existing unit coverage remains green.

### Commit 3 – Wire background entry to new helpers

- 🔄 Modify `src/background/index.ts`
  - Pass `sender.documentId` on `popup-ready`; clear on `popup-closed`.
  - Reschedule hotkey fallback timer when popup closes while copy pending.
- ⏳ Execute targeted Playwright run (`pnpm exec playwright test --grep "popup request pipeline"`).

### Commit 4 – Add focused unit coverage

- 🔄 Extend `tests/unit/background.copy-pipeline.test.ts`
  - Validate queued delivery success path.
  - Assert retry exhaustion triggers `recordError` + fallback copy.
  - Ensure popup-close-before-delivery triggers fallback without messaging.
- ⏳ Re-run `pnpm test`.

### Commit 5 – Introduce coverage tooling dependency

- 🔄 Add `@vitest/coverage-istanbul` to `devDependencies` (update lockfile).

### Commit 6 – Configure coverage thresholds

- 🔄 Adjust `vitest.config.ts`
  - Support provider override via `VITEST_COVERAGE_PROVIDER`.
  - Configure reporters (`text`, `text-summary`, `html`, `lcov`).
  - Exclude dev-only/entry files from threshold calculation.
  - Enforce ≥70% statements & lines, ≥65% branches/functions, and enable `cleanOnRerun`.
- ⏳ Run `pnpm test:coverage` to validate gate behaviour.

### Commit 7 – Document progress and verification

- 🔄 Update `docs/stories/3.8-test-coverage-and-quality-gate.md` with dated progress, commands run, residual risks.
- 🔄 Record summary + verification state in this plan file.
- ⏳ Execute full `pnpm test:e2e` for final confirmation.

## Milestone Checklist

- ⏳ Playwright regression reproduced and root cause documented.
- ⏳ Background/popup handshake refactor merged with unit tests.
- ⏳ Coverage tooling + thresholds in place.
- ⏳ Story doc updated with status + next steps.
- ⏳ All automated suites (`pnpm test`, `pnpm test:coverage`, `pnpm test:e2e`) passing.

## Follow-Ups / Nice-to-Haves

- Assess feasibility of lifting thresholds after covering background `index.ts` and popup clipboard fallback branches.
- Explore instrumentation for context menu + hotkey flows (might feed into Story 3.9).
- Consider CI matrix to detect cross-browser quirks once coverage stabilises.
