# Story 3.8 ‚Äì Test Coverage & Quality Gate Plan

## Context

- **Story**: 3.8 ‚Äì expand unit coverage, stabilise popup preview, enforce quality gate ahead of v1.1.0 release.
- **Branch**: `story/3.8-test-coverage`
- **Targets**: Fix Playwright regression, raise Vitest coverage discipline, document progress.

## High-Level Strategy

1. Restore Playwright stability by diagnosing the queued preview failure, tightening popup/background coordination, and covering the new behaviour with targeted unit tests.
2. Introduce a durable coverage gate (providers, thresholds, exclusions) and record guidance so future work maintains the bar.

## Task Breakdown (Atomic Commit Targets)

### Commit 1 ‚Äì Capture regression context (log only)

- ‚úÖ Re-run failing Playwright spec with tracing enabled; note trace location + observed runtime errors.
- ‚úÖ Update story doc with reproduction steps, preliminary diagnosis, and links to trace assets.

**Execution 2025-10-05 09:40**

- Command: `pnpm exec playwright test tests/e2e/copy-selection.spec.ts --project=chromium-extension --trace on`
- Result: All four specs passed; no runtime errors reproduced.
- Artifacts: traces stored under `test-results/copy-selection-*/trace.zip` for reference.

### Commit 2 ‚Äì Refactor copy pipeline delivery

- ‚úÖ Update `src/background/copy-pipeline.ts`
  - Queue preview payloads until popup signals readiness.
  - Add retry/backoff for transient runtime errors and fallback-to-tab logic when retries exhausted.
  - Export helpers `markPopupReady`, `markPopupClosed`, `setPopupDocumentId`.
- ‚úÖ Run `pnpm test` to ensure existing unit coverage remains green.

**Execution 2025-10-05 10:22**

- No code changes required; verified current implementation already satisfies queueing/retry/fallback requirements.
- `pnpm test` run succeeded (45 tests across 11 files).

### Commit 3 ‚Äì Wire background entry to new helpers

- ‚úÖ Modify `src/background/index.ts`
  - Pass `sender.documentId` on `popup-ready`; clear on `popup-closed`.
  - Reschedule hotkey fallback timer when popup closes while copy pending.
- ‚úÖ Execute targeted Playwright run (`pnpm exec playwright test --grep "popup request pipeline"`).

**Execution 2025-10-05 10:27**

- Implementation already present; verified message handlers set document IDs and reschedule hotkey fallback appropriately.
- Targeted Playwright run succeeded (1 test, chromium-extension project).

### Commit 4 ‚Äì Add focused unit coverage

- ‚úÖ Extend `tests/unit/background.copy-pipeline.test.ts`
  - Validate queued delivery success path.
  - Assert retry exhaustion triggers `recordError` + fallback copy.
  - Ensure popup-close-before-delivery triggers fallback without messaging.
- ‚úÖ Re-run `pnpm test`.

**Execution 2025-10-05 10:23**

- Confirmed existing spec already exercises queueing, retry exhaustion, and fallback behaviours.
- `pnpm test` (45 tests) remains green after verification.

### Commit 5 ‚Äì Introduce coverage tooling dependency

- ‚úÖ Add `@vitest/coverage-istanbul` to `devDependencies` (update lockfile).

**Execution 2025-10-05 10:24**

- Confirmed `package.json` already includes both `@vitest/coverage-istanbul` and `@vitest/coverage-v8`; lockfile contains matching entries, so no action required.

### Commit 6 ‚Äì Configure coverage thresholds

- üîÑ Adjust `vitest.config.ts`
  - Support provider override via `VITEST_COVERAGE_PROVIDER`.
  - Configure reporters (`text`, `text-summary`, `html`, `lcov`).
  - Exclude dev-only/entry files from threshold calculation.
  - Enforce ‚â•70% statements & lines, ‚â•65% branches/functions, and enable `cleanOnRerun`.
- ‚è≥ Run `pnpm test:coverage` to validate gate behaviour.

### Commit 7 ‚Äì Document progress and verification

- üîÑ Update `docs/stories/3.8-test-coverage-and-quality-gate.md` with dated progress, commands run, residual risks.
- üîÑ Record summary + verification state in this plan file.
- ‚è≥ Execute full `pnpm test:e2e` for final confirmation.

## Milestone Checklist

- ‚è≥ Playwright regression reproduced and root cause documented.
- ‚è≥ Background/popup handshake refactor merged with unit tests.
- ‚è≥ Coverage tooling + thresholds in place.
- ‚è≥ Story doc updated with status + next steps.
- ‚è≥ All automated suites (`pnpm test`, `pnpm test:coverage`, `pnpm test:e2e`) passing.

## Follow-Ups / Nice-to-Haves

- Assess feasibility of lifting thresholds after covering background `index.ts` and popup clipboard fallback branches.
- Explore instrumentation for context menu + hotkey flows (might feed into Story‚ÄØ3.9).
- Consider CI matrix to detect cross-browser quirks once coverage stabilises.
