<!-- markdownlint-disable MD013 MD036 -->

# Story 3.9 – End-to-End Coverage Expansion Plan

## Context

- **Story:** 3.9 – extend Playwright suite to mirror real user journeys before v1.1.0 release (see `docs/stories/3.9-end-to-end-coverage.md`).
- **Current coverage:** `tests/e2e/copy-selection.spec.ts` and `tests/e2e/options-rules.spec.ts` cover popup preview basics and rule propagation but skip hotkey, context menu, error lifecycle, onboarding, and clipboard fallback journeys.
- **Goal:** add deterministic scenarios for hotkey command flow, context menu capture, error log maintenance, first-run defaults, and clipboard fallback while keeping runs <5 minutes.

## Observations

- Background exposes an `e2e` message shim (`src/background/e2e.ts`) which we can extend for additional triggers (e.g., invoke command, seed errors, reset badge state).
- Playwright helpers live under `tests/e2e/helpers/`; we can augment them with convenience APIs (`triggerHotkeyCopy`, `invokeContextMenuCopy`, etc.).
- Clipboard fallback + badge logic already have unit coverage; E2E should verify orchestration across surfaces.

## Implementation Strategy

1. Extend the background e2e bridge to support:
   - Triggering the command handler (`background/index.ts`) without real keyboard input.
   - Simulating context menu click for the active tab.
   - Seeding / clearing error log entries, reading badge state.
   - Resetting storage to defaults for first-run scenario.
2. Add Playwright helpers to call the new bridge endpoints and to stub content pages (e.g., fail clipboard API, protected URL).
3. Introduce targeted specs for each user journey with clear setup/cleanup and shared fixtures to avoid duplication.
4. Document how to run the new suites and update CI guidance if runtime increases.

## Atomic Commit Breakdown

### Commit 1 – Augment E2E Bridge & Helpers

- Update `src/background/e2e.ts` + `background/index.ts` to expose new commands for:
  - `e2e:trigger-command` (simulates `copy-selection` hotkey).
  - `e2e:context-copy` (runs the context menu handler).
  - `e2e:get-error-log`, `e2e:seed-error`, `e2e:clear-errors`.
  - `e2e:reset-storage` (restore default options, clear pending state).
- Expand `tests/e2e/helpers/e2e.ts` with wrappers (`triggerHotkeyCopy`, `triggerContextMenuCopy`, `seedErrorLog`, etc.).
- Update unit coverage for the new bridge logic (`tests/unit/background.e2e.test.ts` or extend existing spec).
- Tests: `pnpm test`, `pnpm run test:unit --filter background.e2e`

### Commit 2 – Popup Clipboard Fallback Scenario

- Add `tests/e2e/popup-copy-fallback.spec.ts` verifying:
  - Successful copy preview when clipboard writes succeed.
  - When `navigator.clipboard.writeText` fails, fallback error message surfaces and retry queue behaves.
- Use new helper to force clipboard failure via message or stub.
- Tests: `pnpm exec playwright test tests/e2e/popup-copy-fallback.spec.ts --project=chromium-extension`

### Commit 3 – Hotkey Flow & Fallback Timer

- Add `tests/e2e/hotkey-flow.spec.ts` covering:
  - Invoking hotkey command via `triggerHotkeyCopy` with ready popup.
  - Simulate popup crash (close window before ready) and assert fallback pipeline fires, error recorded.
  - Ensure badge clears after user reopens popup.
- Tests: `pnpm exec playwright test tests/e2e/hotkey-flow.spec.ts --project=chromium-extension`

### Commit 4 – Context Menu Copy & Protected URL Handling

- Add `tests/e2e/context-menu-flow.spec.ts` verifying:
  - Context menu trigger copies selection for normal HTTPS page.
  - Protected URL (e.g., `chrome://settings`) reports warning and logs error without crashing.
- Ensure new helpers reset environment between cases.
- Tests: same Playwright command targeting new spec.

### Commit 5 – Error Log Lifecycle

- Add `tests/e2e/error-log-lifecycle.spec.ts` to:
  - Seed background errors via bridge.
  - Confirm popup badge count and list ordering.
  - Exercise “Clear errors” CTA and assert background storage emptied.
- Tests: targeted Playwright run.

### Commit 6 – First-Run Onboarding Defaults

- Add `tests/e2e/onboarding.spec.ts` verifying:
  - `e2e:reset-storage` yields default options/template.
  - First popup open shows helper status.
  - Copy pipeline works without prior options visit.
- Tests: targeted Playwright run.

### Commit 7 – Docs & CI Updates

- Update `docs/stories/3.9-end-to-end-coverage.md` with progress + references.
- Document new helpers and scenarios in `tests/e2e/README.md`.
- Review GitHub Actions E2E job to ensure new specs run (adjust timeouts if needed).
- Optional: add `pnpm test:e2e --project=chromium-extension --grep smoke` guidance for local smoke subset.

## Validation Checklist

- `pnpm test` (unit + coverage) passes after helper changes.
- `pnpm test:e2e --project=chromium-extension` completes <5 minutes locally.
- No flake observed after 3 consecutive runs of the new specs.
- Story doc updated with completion notes once all commits land.
